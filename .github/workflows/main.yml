name: LSPatch LINE

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'LINEのバージョン (例: 15.12.2)'
        required: true

env:
  # ▼▼▼ 設定エリア ▼▼▼
  SOURCE_REPO: "YuzuMikan404/LINE-APK"
  KEYSTORE_FILE: "keystore.jks"
  STORE_PASSWORD: "your_store_password"
  KEY_ALIAS: "key0"
  KEY_PASSWORD: "your_store_password"
  # ▲▲▲ 設定エリア終了 ▲▲▲

jobs:
  patch-jingmatrix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download Tools
        run: |
          LSPATCH_URL=$(curl -s https://api.github.com/repos/JingMatrix/LSPatch/releases/latest | grep "browser_download_url.*.jar" | head -n 1 | cut -d '"' -f 4)
          wget -O lspatch.jar "$LSPATCH_URL"
          # APKEditorは最新の安定版を使用
          wget -O APKEditor.jar "https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar"

      - name: Download APK from Source Repo
        id: download_apk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir download_tmp
          if gh release download "v$VERSION" --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp; then
            echo "Downloaded v$VERSION"
          elif gh release download "$VERSION" --repo "$SOURCE_REPO" --pattern "*$VERSION*" --dir download_tmp; then
            echo "Downloaded $VERSION"
          else
            echo "Release not found."
            exit 1
          fi
          FILE_PATH=$(find download_tmp -type f \( -name "*.apk" -o -name "*.apkm" -o -name "*.xapk" -o -name "*.apks" \) | head -n 1)
          mv "$FILE_PATH" raw_input_file
          echo "ORIGINAL_FILENAME=$(basename "$FILE_PATH")" >> $GITHUB_ENV

      - name: Prepare APK
        run: |
          FILENAME="${{ env.ORIGINAL_FILENAME }}"
          if [[ "$FILENAME" == *".apkm"* || "$FILENAME" == *".apks"* || "$FILENAME" == *".xapk"* ]]; then
            echo "Merging Split APK (APKM) into single APK..."
            unzip -o raw_input_file -d splitted_apk
            # APKEditorでマージ
            java -jar APKEditor.jar m -i splitted_apk -o target.apk
          else
            mv raw_input_file target.apk
          fi
          if [ ! -f "target.apk" ]; then echo "target.apk not found!"; exit 1; fi

      - name: Run LSPatch (Manager Mode)
        run: |
          # 1. -l を削除 (外部マネージャーを使う場合はManagerモード)
          # 2. -Xmx4G を追加してJavaのメモリを増やす
          # 3. 出力を詳細にするため --verbose (あれば) または標準出力を確認
          java -Xmx4G -jar lspatch.jar target.apk -f -o .
          
          echo "--- Directory List After Patching ---"
          ls -F

      - name: Sign APK (Direct)
        run: |
          # LSPatchの出力は [もとの名]-manager-lspatched.apk または [pkg名]-lspatched.apk になる
          # 確実に拾うため、target.apk 以外の新しくできた apk を探す
          PATCHED_FILE=$(ls *.apk | grep -v "target.apk" | grep -v "lspatch.jar" | grep -v "APKEditor.jar" | head -n 1)
          
          if [ -z "$PATCHED_FILE" ]; then
            echo "Error: Patched APK not found! Check LSPatch logs above."
            exit 1
          fi
          
          echo "Found patched file to sign: $PATCHED_FILE"
          
          BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/* | tail -1)
          APKSIGNER="$BUILD_TOOLS_DIR/apksigner"
          
          "$APKSIGNER" sign \
            --ks "$KEYSTORE_FILE" \
            --ks-pass pass:"$STORE_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --key-pass pass:"$KEY_PASSWORD" \
            --out signed_final.apk \
            "$PATCHED_FILE"

      - name: Rename Output
        run: |
          VERSION="${{ github.event.inputs.version }}"
          mv signed_final.apk LINE-${VERSION}-Patched.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2  # v2にアップデートを推奨
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: LINE ${{ github.event.inputs.version }}
          files: LINE-${{ github.event.inputs.version }}-Patched.apk
          generate_release_notes: true # 変更点などを自動生成
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
